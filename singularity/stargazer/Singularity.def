Bootstrap: docker
From: ubuntu:20.04

%labels
    Software Stargazer
    Version 1.0.9

%environment
    export LC_ALL=C
    export LANG=C
    export PYTHONPATH=/opt
    export PATH=/opt/beagle:$PATH

%post
    set -eux

    # Avoid interactive prompts during package installation
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Etc/UTC

    # -------------------------
    # Base system
    # -------------------------
    apt-get update
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        r-base \
        openjdk-11-jre-headless \
        wget \
        ca-certificates \
        build-essential \
        libbz2-dev \
        liblzma-dev \
        zlib1g-dev

    ln -s /usr/bin/python3 /usr/bin/python

    # -------------------------
    # Python deps
    # -------------------------
    pip3 install --no-cache-dir pysam pandas scipy matplotlib

    # -------------------------
    # Stargazer source
    # -------------------------
    cp -r /build/stargazer/* /opt/

    # -------------------------
    # Beagle (already bundled)
    # -------------------------
    mkdir -p /opt/beagle
    cp /opt/beagle.*.jar /opt/beagle/beagle.jar

    cat << 'EOF' > /usr/local/bin/beagle
#!/bin/bash
exec java -Xmx4g -jar /opt/beagle/beagle.jar "$@"
EOF
    chmod +x /usr/local/bin/beagle

    # Create stargazer executable wrapper
    cat << 'EOF' > /usr/local/bin/stargazer
#!/bin/bash
exec python /opt/__main__.py "$@"
EOF
    chmod +x /usr/local/bin/stargazer

    # Cleanup
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%files
    . /build/stargazer

%runscript
    exec python /opt/__main__.py "$@"

%help
    Stargazer â€“ pharmacogenomics star allele caller

    Example:
      singularity run stargazer.sif -h
